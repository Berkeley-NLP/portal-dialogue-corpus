<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Portal Dialogue Corpus - Data Explorer</title>
    <link rel="stylesheet" href="style.css?v=1.0.1">
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <!-- Import Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Papa Parse for fast client‑side CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div id="main">
        <div id="header">
            <h1>The Portal Dialogue Corpus</h1>
            <div id="authors">
                <ul>
                    <li><a href="https://nickatomlin.github.io/">Nicholas Tomlin</a>*<sup>12</sup></li>
                    <li><a href="https://naitian.org/">Naitian Zhou</a>*<sup>1</sup></li>
                    <li><a href="https://www.efleisig.com/">Eve Fleisig</a><sup>1</sup></li>
                    <li><a href="https://circlecly.github.io/">Liangyuan (Circle) Chen</a><sup>1</sup></li>
                    <li><a href="https://teaywright.github.io/">Téa Wright</a><sup>1</sup></li>
                    <li><a href="https://www.linkedin.com/in/lauren-vinh-b19473217/">Lauren Vinh</a><sup>1</sup></li>
                    <li><a href="https://www.linkedin.com/in/laura-ma-280406248/">Laura X. Ma</a><sup>1</sup></li>
                    <li><a href="https://seuneisape.github.io/">Seun Eisape</a><sup>1</sup></li>
                    <li><a href="https://www.linkedin.com/in/ellie-french-21133a277/">Ellie French</a><sup>1</sup></li>
                    <li><a href="https://www.linkedin.com/in/olivia-tingting-du/?locale=zh_CN">Tingting Du</a><sup>1</sup></li>
                    <li><a href="https://scholar.google.com/citations?user=LphJyswAAAAJ&hl=en">Tianjiao Zhang</a><sup>1</sup></li>
                    <li><a href="https://www.coli.uni-saarland.de/~koller/">Alexander Koller</a><sup>3</sup></li>
                    <li><a href="https://www.alanesuhr.com/">Alane Suhr</a><sup>1</sup></li>
                </ul>
            </div>
            <p><sup>1</sup> UC Berkeley &nbsp;&nbsp;&nbsp; <sup>2</sup> NYU &nbsp;&nbsp;&nbsp; <sup>3</sup> Saarland University &nbsp;&nbsp;&nbsp; * Equal Contribution</p>
            <div id="links">
                <div class="link">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </div>
                <div class="link">
                    <a href="#"><i class="fas fa-file-alt"></i> Paper</a>
                </div>
                <div class="link">
                    <a href="https://huggingface.co/datasets/Berkeley-NLP/portal2"><i class="fas fa-database"></i> Hugging Face</a>
                </div>
                <div class="link">
                    <a href="explorer.html"><i class="fas fa-search"></i> Data Explorer</a>
                </div>
            </div>
        </div>

        <div class="data-explorer-container">
            <h2>Dialogue Data Explorer</h2>
            
            <div class="controls-row">
                <label for="sessionSelect">Session:</label>
                <select id="sessionSelect">
                    <option value="">-- choose session --</option>
                </select>

                <label for="levelSelect">Level:</label>
                <select id="levelSelect" disabled>
                    <option value="">-- choose level --</option>
                </select>

                <div class="toggle-container">
                    <span>Timeline View</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="viewToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="search-container">
                <label for="searchInput">Search across all dialogues:</label>
                <input type="text" id="searchInput" placeholder="Enter text or tags to search (e.g., 'hello', 'Query', 'utterance Type: query')..." style="width: 500px;">
                <span id="searchResults"></span>
            </div>

            <div id="searchResultsList" class="search-results"></div>

            <div id="contentContainer" class="content-container">
                <div id="videoContainer" class="video-container" style="display: none;">
                    <h3 id="videoTitle">Video for Current Session/Level</h3>
                    <iframe id="videoEmbed" width="100%" height="315" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>

                <div id="utterancesContainer" class="utterances-container">
                    <div id="utterances"></div>
                    
                    <div id="timelineContainer" class="timeline-container">
                        <div class="timeline-column blue" id="blueColumn"></div>
                        <div class="timeline-column orange" id="orangeColumn"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let data = [];
        let currentSession = '';
        let currentLevel = '';
        let isTimelineView = false;
        let activeTooltip = null;

        // YouTube video mapping dictionary
        const youtubeVideoMapping = {
            '01-Course1_Level1': 'https://www.youtube.com/watch?v=ZQfvFkhU0rA',
            '01-Course1_Level2': 'https://www.youtube.com/watch?v=BnnXwO_QOQM',
            '01-Course1_Level3': 'https://www.youtube.com/watch?v=7534m5zPqio',
            '01-Course1_Level4': 'https://www.youtube.com/watch?v=Kw-1XF2xcq0',
            '01-Course1_Level5': 'https://www.youtube.com/watch?v=5lnGevgdsAg',
            '01-Course1_Level6': 'https://www.youtube.com/watch?v=7ba5BnO9sTU',

            '02-Course1_Level1': 'https://www.youtube.com/watch?v=LZ_FuVlZBFU',
            '02-Course1_Level2': 'https://www.youtube.com/watch?v=onKxcLWVbwU',
            '02-Course1_Level3': 'https://www.youtube.com/watch?v=6K-NgJLBz6A',
            '02-Course1_Level4': 'https://www.youtube.com/watch?v=yf2IURs_26o',
            '02-Course1_Level5': 'https://www.youtube.com/watch?v=ltmxPPynSFw',
            '02-Course1_Level6': 'https://www.youtube.com/watch?v=DeBDZ642nR0',

            '03-Course1_Level1': 'https://www.youtube.com/watch?v=aH5IDckuVlQ',
            '03-Course1_Level2': 'https://www.youtube.com/watch?v=OCPPvkY8S-8',
            '03-Course1_Level3': 'https://www.youtube.com/watch?v=4WuH084_Mmo',
            '03-Course1_Level4': 'https://www.youtube.com/watch?v=yF-MsCQCTd4',
            '03-Course1_Level5': 'https://www.youtube.com/watch?v=zEF-EFeAxCY',
            '03-Course1_Level6': 'https://www.youtube.com/watch?v=JKeUGx623hw',

            '04-Course1_Level1': 'https://www.youtube.com/watch?v=pAhdBuWy1lY',
            '04-Course1_Level2': 'https://www.youtube.com/watch?v=pAP27AYsGhE',
            '04-Course1_Level3': 'https://www.youtube.com/watch?v=1TKCujUNoXw',
            '04-Course1_Level4': 'https://www.youtube.com/watch?v=yNw41ssA6zQ',
            '04-Course1_Level5': 'https://www.youtube.com/watch?v=aD9VBZRpjlM',
            '04-Course1_Level6': 'https://www.youtube.com/watch?v=6Gm5wy35mqY',
            '04-Course3_Level1': 'https://www.youtube.com/watch?v=UDV2AAXTo7s',
            '04-Course3_Level2': 'https://www.youtube.com/watch?v=TmV09gyNdZU',

            '05-Course1_Level1': 'https://www.youtube.com/watch?v=dNWgee-r00A',
            '05-Course1_Level2': 'https://www.youtube.com/watch?v=gy1pQtaGxcw',
            '05-Course1_Level3': 'https://www.youtube.com/watch?v=7tATnSuvG5o',
            '05-Course1_Level4': 'https://www.youtube.com/watch?v=WNR70S5nlNA',
            '05-Course1_Level5': 'https://www.youtube.com/watch?v=dNWgee-r00A',
            '05-Course1_Level6': 'https://www.youtube.com/watch?v=pYm47qTfmP4',
            '05-Course3_Level1': 'https://www.youtube.com/watch?v=NXge3a7rErA',
            '05-Course3_Level2': 'https://www.youtube.com/watch?v=tp35RNiCmmI',
            '05-Course3_Level3': 'https://www.youtube.com/watch?v=IdwMax1jhQI',
            '05-Course3_Level4': 'https://www.youtube.com/watch?v=5Yulv398ddU',

            '06-Course1_Level1': 'https://www.youtube.com/watch?v=0AGfr1jNm8c',
            '06-Course1_Level2': 'https://www.youtube.com/watch?v=4jQORd-DtTo',
            '06-Course1_Level3': 'https://www.youtube.com/watch?v=f2c6jFDUGcE',
            '06-Course1_Level4': 'https://www.youtube.com/watch?v=mEjq64-mccA',
            '06-Course1_Level5': 'https://www.youtube.com/watch?v=6mlJlyOH3g8',
            '06-Course1_Level6': 'https://www.youtube.com/watch?v=Tr-2He9KeUk',

            '07-Course1_Level1': 'https://www.youtube.com/watch?v=A8RgqKZkBqo',
            '07-Course1_Level2': 'https://www.youtube.com/watch?v=6Y0Z9jVTeRA',
            '07-Course1_Level3': 'https://www.youtube.com/watch?v=H5Z0Zzm03k8',
            '07-Course1_Level4': 'https://www.youtube.com/watch?v=cVZ_SR269z8',
            '07-Course1_Level5': 'https://www.youtube.com/watch?v=A-cnUIm0gxo',
            '07-Course1_Level6': 'https://www.youtube.com/watch?v=rv5CP7hVq0I',

            '08-Course1_Level1': 'https://www.youtube.com/watch?v=NKqP8cqefac',
            '08-Course1_Level2': 'https://www.youtube.com/watch?v=X9OTOPm1SL0',
            '08-Course1_Level3': 'https://www.youtube.com/watch?v=s-N-BbRQqzU',
            '08-Course1_Level4': 'https://www.youtube.com/watch?v=Hwr9xrPtdv4',
            '08-Course1_Level5': 'https://www.youtube.com/watch?v=02BfVIs2dLQ',
            '08-Course1_Level6': 'https://www.youtube.com/watch?v=_PzI7XevnaM',
            '08-Course3_Level1': 'https://www.youtube.com/watch?v=BrBS0oDY3_A',
            '08-Course3_Level2': 'https://www.youtube.com/watch?v=M_sO1rYK914',

            '09-Course1_Level1': 'https://www.youtube.com/watch?v=kJK7boAsN9c',
            '09-Course1_Level2': 'https://www.youtube.com/watch?v=g3zcxCnHWWo',
            '09-Course1_Level3': 'https://www.youtube.com/watch?v=5x7LkMMCT-I',
            '09-Course1_Level4': 'https://www.youtube.com/watch?v=-zoxRIQC0uY',
            '09-Course1_Level5': 'https://www.youtube.com/watch?v=XNSUqz4YwFQ',
            '09-Course1_Level6': 'https://www.youtube.com/watch?v=KtT4lavDxGI',
            '09-Course3_Level1': 'https://www.youtube.com/watch?v=0dtd1kcBN20',
            '09-Course3_Level2': 'https://www.youtube.com/watch?v=C4lJEZxaqjQ',
            '09-Course3_Level3': 'https://www.youtube.com/watch?v=rrdpRT-AKVA',
            '09-Course3_Level4': 'https://www.youtube.com/watch?v=X3o797CbCG8',

            '10-Course1_Level1': 'https://www.youtube.com/watch?v=uAnpYj39sAk',
            '10-Course1_Level2': 'https://www.youtube.com/watch?v=X5ngBVIEXc4',
            '10-Course1_Level3': 'https://www.youtube.com/watch?v=zAE6dzbw6Fw',
            '10-Course1_Level4': 'https://www.youtube.com/watch?v=E7qqeJphUWc',
            '10-Course1_Level5': 'https://www.youtube.com/watch?v=Aay_chq19Hk',
            '10-Course1_Level6': 'https://www.youtube.com/watch?v=skt_Mkz1RsI',
            '10-Course3_Level1': 'https://www.youtube.com/watch?v=iyvGcGlBveo',
            '10-Course3_Level2': 'https://www.youtube.com/watch?v=HlOctEGMBiU',
            '10-Course3_Level3': 'https://www.youtube.com/watch?v=S2M4Sm-e84c',

            '11-Course1_Level1': 'https://www.youtube.com/watch?v=r_cBWfAztGU',
            '11-Course1_Level2': 'https://www.youtube.com/watch?v=P0C5MUFqSAo',
            '11-Course1_Level3': 'https://www.youtube.com/watch?v=SuzECaT_qJw',
            '11-Course1_Level4': 'https://www.youtube.com/watch?v=91gpECeBW9g',
            '11-Course1_Level5': 'https://www.youtube.com/watch?v=l2pAmlwt7E4',
            '11-Course1_Level6': 'https://www.youtube.com/watch?v=uSxZbhrg9lA',
            '11-Course3_Level1': 'https://www.youtube.com/watch?v=3AX1pD_MFw4',
            '11-Course3_Level2': 'https://www.youtube.com/watch?v=MOWI8UWafL4',

            '12-Course1_Level1': 'https://www.youtube.com/watch?v=X4UPOHPEXoI',
            '12-Course1_Level2': 'https://www.youtube.com/watch?v=tDh4bq9b9zo',
            '12-Course1_Level3': 'https://www.youtube.com/watch?v=KXizAzjvyWE',
            '12-Course1_Level4': 'https://www.youtube.com/watch?v=q95wHWuXH0A',
            '12-Course1_Level5': 'https://www.youtube.com/watch?v=ZYdJevA8uxU',
            '12-Course1_Level6': 'https://www.youtube.com/watch?v=4ETUPqNhKPI',
            '12-Course3_Level1': 'https://www.youtube.com/watch?v=FZTTMov4Hy0',
            '12-Course3_Level2': 'https://www.youtube.com/watch?v=14jl9YPYsD4',
            '12-Course3_Level3': 'https://www.youtube.com/watch?v=VdexBOuq42A',

            '13-Course1_Level1': 'https://www.youtube.com/watch?v=zLGJY0aYNCM',
            '13-Course1_Level2': 'https://www.youtube.com/watch?v=3fLHSUH3ipo',
            '13-Course1_Level3': 'https://www.youtube.com/watch?v=G0Hob99oemU',
            '13-Course1_Level4': 'https://www.youtube.com/watch?v=jUSIweMEY5M',
            '13-Course1_Level5': 'https://www.youtube.com/watch?v=ivb7kHcY4OU',
            '13-Course1_Level6': 'https://www.youtube.com/watch?v=JewvJwkHs4U',

            '14-Course1_Level1': 'https://www.youtube.com/watch?v=hXYgNxAeaIU',
            '14-Course1_Level2': 'https://www.youtube.com/watch?v=FAa_VavjpjU',
            '14-Course1_Level3': 'https://www.youtube.com/watch?v=tO--TbgBxao',
            '14-Course1_Level4': 'https://www.youtube.com/watch?v=afCWWqn3L3w',
            '14-Course1_Level5': 'https://www.youtube.com/watch?v=toXT9q4ONfM',
            '14-Course1_Level6': 'https://www.youtube.com/watch?v=v82BaqPJ7Cs',
            '14-Course3_Level1': 'https://www.youtube.com/watch?v=ckoa9eXeBoc',
            '14-Course3_Level2': 'https://www.youtube.com/watch?v=GLo9nKLp93s',
            '14-Course3_Level3': 'https://www.youtube.com/watch?v=3zYNjuFCk2I',
            '14-Course3_Level4': 'https://www.youtube.com/watch?v=L9bG_RRb_6A',
            '14-Course3_Level5': 'https://www.youtube.com/watch?v=wv1Y3Q0HckU',

            '15-Course1_Level1': 'https://www.youtube.com/watch?v=o72p5KRth68',
            '15-Course1_Level2': 'https://www.youtube.com/watch?v=UfB_twOHX2I',
            '15-Course1_Level3': 'https://www.youtube.com/watch?v=KUsw_ZqSi2E',
            '15-Course1_Level4': 'https://www.youtube.com/watch?v=x6ZmU0aqqmI',
            '15-Course1_Level5': 'https://www.youtube.com/watch?v=6ssz72cQCiA',
            '15-Course1_Level6': 'https://www.youtube.com/watch?v=1EMYy2VTQPA',
            '15-Course3_Level1': 'https://www.youtube.com/watch?v=Vvea459bMSM',
            '15-Course3_Level2': 'https://www.youtube.com/watch?v=96NH7hXTDTw',
            '15-Course3_Level3': 'https://www.youtube.com/watch?v=Yc5NvmkoPXM',
            '15-Course3_Level4': 'https://www.youtube.com/watch?v=DrIMUX0Ahak',
            '15-Course3_Level5': 'https://www.youtube.com/watch?v=camj2goB1qI',
            
            '16-Course1_Level1': 'https://www.youtube.com/watch?v=caGL8f6PIY4',
            '16-Course1_Level2': 'https://www.youtube.com/watch?v=9a-8zIyW8S4',
            '16-Course1_Level3': 'https://www.youtube.com/watch?v=smjxSQpUii4',
            '16-Course1_Level4': 'https://www.youtube.com/watch?v=IRGM8zHfjbk',
            '16-Course1_Level5': 'https://www.youtube.com/watch?v=oRy_q0ye01w',
            '16-Course1_Level6': 'https://www.youtube.com/watch?v=2IUlBTYPrtg',
            '16-Course3_Level1': 'https://www.youtube.com/watch?v=Ev9TVnuwpiM',
            '16-Course3_Level2': 'https://www.youtube.com/watch?v=2GB9fSt_RH8',
            '16-Course3_Level3': 'https://www.youtube.com/watch?v=KUrrfPw9Pfo',
            '16-Course3_Level4': 'https://www.youtube.com/watch?v=LS2ahdf3A1w',
            '16-Course3_Level5': 'https://www.youtube.com/watch?v=je1qZ68cRdE',
            '16-Course3_Level6': 'https://www.youtube.com/watch?v=zjCTF6-BVc4',
            '16-Course3_Level7': 'https://www.youtube.com/watch?v=220SeoDEXUg',
            '16-Course3_Level8': 'https://www.youtube.com/watch?v=N4SpWS3aGYI',

            '17-Course1_Level1': 'https://www.youtube.com/watch?v=R5IT6v3Ts0k',
            '17-Course1_Level2': 'https://www.youtube.com/watch?v=wOF6zzRvii0',
            '17-Course1_Level3': 'https://www.youtube.com/watch?v=AR9sReLAaeU',
            '17-Course1_Level4': 'https://www.youtube.com/watch?v=8ozpQEWW2aE',
            '17-Course1_Level5': 'https://www.youtube.com/watch?v=pfmqoGcH3wc',
            '17-Course1_Level6': 'https://www.youtube.com/watch?v=HxVqsyIM5KY',
            '17-Course3_Level1': 'https://www.youtube.com/watch?v=nHgdVPI3MlM',
            '17-Course3_Level2': 'https://www.youtube.com/watch?v=spwjvZsfIt4',
            '17-Course3_Level3': 'https://www.youtube.com/watch?v=TpNkhhMSYf8',
            '17-Course3_Level4': 'https://www.youtube.com/watch?v=xQBVSKWrWTo',

            '18-Course1_Level1': 'https://www.youtube.com/watch?v=l3w5Gq1aTTo',
            '18-Course1_Level2': 'https://www.youtube.com/watch?v=i5-gLH4eyjU',
            '18-Course1_Level3': 'https://www.youtube.com/watch?v=Yw8sHCp_67E',
            '18-Course1_Level4': 'https://www.youtube.com/watch?v=hDHvKTzVktY',
            '18-Course1_Level5': 'https://www.youtube.com/watch?v=6eLj-d--Tkk',
            '18-Course1_Level6': 'https://www.youtube.com/watch?v=P4lPSNDavS4',
            '18-Course3_Level1': 'https://www.youtube.com/watch?v=OInaiVH206c',
            '18-Course3_Level2': 'https://www.youtube.com/watch?v=rmxtzi6v_ZM',
            '18-Course3_Level3': 'https://www.youtube.com/watch?v=w7rpSMwbSds'
        };

        // Function to get YouTube video URL for a session/level combination
        function getYouTubeVideoUrl(session, level) {
            const key = `${session}-${level}`;
            return youtubeVideoMapping[key] || null;
        }

        // Function to convert YouTube URL to embeddable format
        function convertToEmbedUrl(youtubeUrl) {
            if (!youtubeUrl) return null;
            
            // Extract video ID from various YouTube URL formats
            const videoIdMatch = youtubeUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/);
            if (!videoIdMatch) return null;
            
            const videoId = videoIdMatch[1];
            return `https://www.youtube.com/embed/${videoId}?enablejsapi=1`;
        }

        // Function to show embedded video for current session/level
        function showEmbeddedVideo(session, level) {
            const videoContainer = document.getElementById('videoContainer');
            const videoEmbed = document.getElementById('videoEmbed');
            const videoTitle = document.getElementById('videoTitle');
            
            const videoUrl = getYouTubeVideoUrl(session, level);
            if (!videoUrl) {
                videoContainer.style.display = 'none';
                return;
            }
            
            const embedUrl = convertToEmbedUrl(videoUrl);
            if (!embedUrl) {
                videoContainer.style.display = 'none';
                return;
            }
            
            videoEmbed.src = embedUrl;
            videoTitle.textContent = `Video for Session ${session}, Level ${level}`;
            videoContainer.style.display = 'block';
        }

        // Function to create timestamp link that seeks the embedded video
        function createYouTubeTimestampLink(timestamp, session, level) {
            const videoUrl = getYouTubeVideoUrl(session, level);
            if (!videoUrl) {
                return timestamp; // Return plain timestamp if no video available
            }

            // Convert timestamp to seconds
            const seconds = timeToSeconds(timestamp);
            
            // Create clickable timestamp that seeks the embedded video
            return `<a href="javascript:void(0)" onclick="seekEmbeddedVideo(${seconds})" class="youtube-timestamp-link">${timestamp}</a>`;
        }

        // Function to seek the embedded video to a specific time
        function seekEmbeddedVideo(seconds) {
            const videoEmbed = document.getElementById('videoEmbed');
            const videoContainer = document.getElementById('videoContainer');
            
            // If video is not visible, show it first
            if (videoContainer.style.display === 'none') {
                return;
            }
            
            // Use postMessage to control the embedded YouTube player
            videoEmbed.contentWindow.postMessage(
                '{"event":"command","func":"seekTo","args":[' + seconds + ',true]}',
                '*'
            );
            
            // Since video is always visible when content is loaded, no need to scroll
        }

        // Custom tooltip functions
        function createTooltip(text) {
            const tooltip = document.createElement('div');
            tooltip.className = 'custom-tooltip';
            tooltip.textContent = text;
            document.body.appendChild(tooltip);
            return tooltip;
        }

        function positionTooltip(tooltip, target) {
            const rect = target.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let left = rect.left + (rect.width / 2);
            let top = rect.top;

            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            if (left < tooltipRect.width / 2) {
                left = tooltipRect.width / 2;
            } else if (left + (tooltipRect.width / 2) > viewportWidth) {
                left = viewportWidth - (tooltipRect.width / 2);
            }
            
            if (top < tooltipRect.height) {
                top = rect.bottom + 8;
                tooltip.style.transform = 'translateX(-50%) translateY(0)';
            } else {
                top = top;
                tooltip.style.transform = 'translateX(-50%) translateY(-100%)';
            }
            
            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;
        }

        function showTooltip(e) {
            if (activeTooltip) {
                activeTooltip.remove();
            }
            const text = e.target.getAttribute('title');
            if (text) {
                e.target.removeAttribute('title');
                activeTooltip = createTooltip(text);
                positionTooltip(activeTooltip, e.target);
            }
        }

        function hideTooltip(e) {
            if (activeTooltip) {
                e.target.setAttribute('title', activeTooltip.textContent);
                activeTooltip.remove();
                activeTooltip = null;
            }
        }

        function setupTooltipListeners(element) {
            element.addEventListener('mouseenter', showTooltip);
            element.addEventListener('mouseleave', hideTooltip);
            let parent = element.parentElement;
            while (parent) {
                if (parent.scrollHeight > parent.clientHeight) {
                    parent.addEventListener('scroll', () => {
                        if (activeTooltip && activeTooltip.dataset.target === element) {
                            positionTooltip(activeTooltip, element);
                        }
                    });
                }
                parent = parent.parentElement;
            }
        }

        window.addEventListener('scroll', () => {
            if (activeTooltip) {
                const target = document.querySelector(`[title="${activeTooltip.textContent}"]`);
                if (target) {
                    positionTooltip(activeTooltip, target);
                }
            }
        }, true);

        window.addEventListener('resize', () => {
            if (activeTooltip) {
                const target = document.querySelector(`[title="${activeTooltip.textContent}"]`);
                if (target) {
                    positionTooltip(activeTooltip, target);
                }
            }
        });

        // Tag mapping for abbreviations
        const tagMappings = {
            'Success': { abbr: 'SUC', full: 'Communicative status: Success', category: 'comm' },
            'Abandoned': { abbr: 'ABN', full: 'Communicative status: Abandoned', category: 'comm' },
            'Correction': { abbr: 'COR', full: 'Communicative status: Correction', category: 'comm' },
            'Uninterpretable': { abbr: 'UNI', full: 'Communicative status: Uninterpretable', category: 'comm' },
            'Task-Related': { abbr: 'TSK', full: 'Information level: Task-Related', category: 'info' },
            'Communication Management': { abbr: 'COM', full: 'Information level: Communication Management', category: 'info' },
            'Affective Evaluation': { abbr: 'AFF', full: 'Information level: Affective Evaluation', category: 'info' },
            'World State': { abbr: 'WLD', full: 'Information level: World State', category: 'info' },
            'Not Enough Information': { abbr: 'NEI', full: 'Information level: Not Enough Information', category: 'info' },
            'Hedging': { abbr: 'HED', full: 'Uncertainty: Hedging', category: 'unc' },
            'Certainty': { abbr: 'CER', full: 'Uncertainty: Certainty', category: 'unc' },
            'Non-Sentential / Listener Response': { abbr: 'NSL', full: 'Uncertainty: Non-Sentential / Listener Response', category: 'unc' },
            'Imperative': { abbr: 'IMP', full: 'Uncertainty: Imperative', category: 'unc' },
            'Proposition': { abbr: 'PRO', full: 'Utterance type: Proposition', category: 'utt' },
            'Exclamation': { abbr: 'EXC', full: 'Utterance type: Exclamation', category: 'utt' },
            'Query': { abbr: 'QRY', full: 'Utterance type: Query', category: 'utt' },
            'Confirmation/Status Marker': { abbr: 'CSM', full: 'Discursive act: Confirmation/Status Marker', category: 'dis' },
            'Speculation, Not Enough Information': { abbr: 'SNI', full: 'Discursive act: Speculation, Not Enough Information', category: 'dis' }
        };

        const categoryColors = {
            'comm': { bg: 'rgba(255, 182, 193, 0.8)', text: '#8B0000' },
            'info': { bg: 'rgba(173, 216, 230, 0.8)', text: '#00008B' },
            'unc': { bg: 'rgba(144, 238, 144, 0.8)', text: '#006400' },
            'utt': { bg: 'rgba(255, 218, 185, 0.8)', text: '#8B4513' },
            'dis': { bg: 'rgba(221, 160, 221, 0.8)', text: '#4B0082' }
        };

        function toggleView() {
            isTimelineView = !isTimelineView;
            const toggleBtn = document.getElementById('viewToggle');
            const utterancesDiv = document.getElementById('utterances');
            const timelineDiv = document.getElementById('timelineContainer');
            
            if (isTimelineView) {
                toggleBtn.checked = true;
                utterancesDiv.style.display = 'none';
                timelineDiv.classList.add('active');
            } else {
                toggleBtn.checked = false;
                utterancesDiv.style.display = 'block';
                timelineDiv.classList.remove('active');
            }
            
            if (currentSession && currentLevel) {
                displayUtterances(currentSession, currentLevel, document.getElementById('searchInput').value);
            }
        }

        function timeToSeconds(t) {
            if (!t) return 0;
            const parts = t.split(':');
            const secParts = parts[2].split('.');
            return (+parts[0]) * 3600 + (+parts[1]) * 60 + (+secParts[0]) + (+(secParts[1] || 0)) / 1000;
        }

        function highlightSearchTerms(text, searchTerm) {
            if (!searchTerm) return text;
            // Escape special regex characters to treat them as literal text
            const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        // Check if a tag matches the search term (searches in value, abbreviation, and full description)
        function tagMatchesSearch(tagValue, searchTerm) {
            if (!searchTerm) return false;
            const searchLower = searchTerm.toLowerCase();
            const tagInfo = getTagInfo(tagValue);
            
            const searchTargets = [
                tagValue.toLowerCase(),
                tagInfo ? tagInfo.abbr.toLowerCase() : '',
                tagInfo ? tagInfo.full.toLowerCase() : ''
            ];
            
            return searchTargets.some(target => target.includes(searchLower));
        }

        function getTagInfo(value) {
            if (!value || value.trim() === '') return null;
            
            const cleanValue = value.replace(/^["']|["']$/g, '').trim();
            
            if (tagMappings[cleanValue]) {
                return tagMappings[cleanValue];
            }
            
            for (const [key, info] of Object.entries(tagMappings)) {
                if (cleanValue.includes(key) || key.includes(cleanValue)) {
                    return info;
                }
            }
            
            const words = cleanValue.split(' ');
            const abbr = words.map(word => word.charAt(0).toUpperCase()).join('').substring(0, 3);
            return { abbr, full: cleanValue, category: 'unknown' };
        }

        function getPreviewSnippet(utterance, searchTerm, maxLength = 100) {
            if (!searchTerm) return utterance;
            
            const searchLower = searchTerm.toLowerCase();
            const utteranceLower = utterance.toLowerCase();
            const index = utteranceLower.indexOf(searchLower);
            
            if (index === -1) return utterance;
            
            const start = Math.max(0, index - 30);
            const end = Math.min(utterance.length, index + searchTerm.length + 30);
            
            let snippet = utterance.substring(start, end);
            
            if (start > 0) snippet = '...' + snippet;
            if (end < utterance.length) snippet = snippet + '...';
            
            return snippet;
        }

        function searchAcrossAllData(searchTerm) {
            if (!searchTerm.trim()) {
                return [];
            }

            const searchLower = searchTerm.toLowerCase();
            const matches = new Map(); // Map to store (session, level) -> {count, snippets}

            data.forEach(row => {
                const utterance = row.utterance || '';
                let hasMatch = false;
                let matchSnippets = [];
                
                // Search in utterance text
                if (utterance.toLowerCase().includes(searchLower)) {
                    hasMatch = true;
                    matchSnippets.push({
                        type: 'text',
                        content: getPreviewSnippet(utterance, searchTerm),
                        label: 'Text'
                    });
                }
                
                // Search in tag fields
                const tagFields = [
                    { field: 'communicative_status', label: 'Communicative Status' },
                    { field: 'information_level', label: 'Information Level' },
                    { field: 'uncertainty', label: 'Uncertainty' },
                    { field: 'utterance_type', label: 'Utterance Type' },
                    { field: 'discursive_act', label: 'Discursive Act' }
                ];
                
                tagFields.forEach(({field, label}) => {
                    const tagValue = row[field] || '';
                    const tagInfo = getTagInfo(tagValue);
                    
                    // Search in raw tag value, abbreviation, and full description
                    const searchTargets = [
                        tagValue.toLowerCase(),
                        tagInfo ? tagInfo.abbr.toLowerCase() : '',
                        tagInfo ? tagInfo.full.toLowerCase() : ''
                    ];
                    
                    if (searchTargets.some(target => target.includes(searchLower))) {
                        hasMatch = true;
                        matchSnippets.push({
                            type: 'tag',
                            content: tagValue,
                            label: label,
                            abbr: tagInfo ? tagInfo.abbr : '',
                            full: tagInfo ? tagInfo.full : tagValue
                        });
                    }
                });
                
                if (hasMatch) {
                    const key = `${row.session}-${row.level}`;
                    if (!matches.has(key)) {
                        matches.set(key, { count: 0, snippets: [] });
                    }
                    const match = matches.get(key);
                    match.count++;
                    match.snippets.push(...matchSnippets);
                }
            });

            // Convert to array and sort by count (descending)
            return Array.from(matches.entries())
                .map(([key, matchData]) => {
                    const [session, level] = key.split('-');
                    return { 
                        session, 
                        level, 
                        count: matchData.count,
                        snippets: matchData.snippets.slice(0, 5) // Show up to 5 snippets to accommodate both text and tag matches
                    };
                })
                .sort((a, b) => b.count - a.count);
        }

        function displaySearchResults(searchTerm) {
            const container = document.getElementById('searchResultsList');
            const resultsSpan = document.getElementById('searchResults');
            const utterancesContainer = document.getElementById('utterances');
            
            if (!searchTerm.trim()) {
                container.innerHTML = '';
                resultsSpan.textContent = '';
                utterancesContainer.innerHTML = '';
                return;
            }

            const results = searchAcrossAllData(searchTerm);
            
            if (results.length === 0) {
                container.innerHTML = '<p>No matches found.</p>';
                resultsSpan.textContent = '';
                utterancesContainer.innerHTML = '';
                return;
            }

            resultsSpan.textContent = `Found ${results.length} session/level combinations with matches`;
            
            container.innerHTML = '<h3>Search Results:</h3>';
            utterancesContainer.innerHTML = '';
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                
                let snippetsHtml = '';
                if (result.snippets.length > 0) {
                    snippetsHtml = '<div class="search-result-snippet">';
                    
                    // Group snippets by type to avoid duplication
                    const textSnippets = result.snippets.filter(s => s.type === 'text');
                    const tagSnippets = result.snippets.filter(s => s.type === 'tag');
                    
                    // Show text snippets
                    if (textSnippets.length > 0) {
                        snippetsHtml += '<div><strong>Text matches:</strong></div>';
                        textSnippets.forEach(snippet => {
                            snippetsHtml += `<div>${highlightSearchTerms(snippet.content, searchTerm)}</div>`;
                        });
                    }
                    
                    // Show tag snippets
                    if (tagSnippets.length > 0) {
                        snippetsHtml += '<div><strong>Tag matches:</strong></div>';
                        // Remove duplicates by creating a Set of unique tag descriptions
                        const uniqueTags = new Map();
                        tagSnippets.forEach(snippet => {
                            const key = `${snippet.label}: ${snippet.content}`;
                            if (!uniqueTags.has(key)) {
                                uniqueTags.set(key, snippet);
                            }
                        });
                        
                        uniqueTags.forEach(snippet => {
                            const displayText = snippet.abbr ? 
                                `${snippet.label}: ${snippet.content} (${snippet.abbr})` : 
                                `${snippet.label}: ${snippet.content}`;
                            snippetsHtml += `<div>${highlightSearchTerms(displayText, searchTerm)}</div>`;
                        });
                    }
                    
                    snippetsHtml += '</div>';
                }
                
                item.innerHTML = `
                    <strong>Session ${result.session}, Level ${result.level}</strong>
                    <span class="search-result-count">(${result.count} matches)</span>
                    ${snippetsHtml}
                `;
                
                item.addEventListener('click', () => {
                    // Update current values
                    currentSession = result.session;
                    currentLevel = result.level;
                    
                    // Update session dropdown
                    document.getElementById('sessionSelect').value = result.session;
                    
                    // Enable level dropdown and populate it
                    populateLevels(currentSession);
                    
                    // Set level dropdown after it gets populated
                    document.getElementById('levelSelect').value = result.level;
                    
                    // Display the dialogue
                    displayUtterances(currentSession, currentLevel, searchTerm);
                    
                    // Hide search results
                    container.innerHTML = '';
                    resultsSpan.textContent = '';
                    
                    // Scroll to utterances
                    document.getElementById('utterances').scrollIntoView({ behavior: 'smooth' });
                });
                
                container.appendChild(item);
            });
        }

        function populateSessions() {
            const sessionSel = document.getElementById('sessionSelect');
            const sessions = [...new Set(data.map(d => d.session))].sort();
            sessions.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                sessionSel.appendChild(opt);
            });
        }

        function populateLevels(session) {
            const levelSel = document.getElementById('levelSelect');
            levelSel.innerHTML = '<option value="">-- choose level --</option>';
            if (!session) { levelSel.disabled = true; return; }
            const levels = [...new Set(data.filter(d => d.session === session).map(d => d.level))].sort();
            levels.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l;
                opt.textContent = l;
                levelSel.appendChild(opt);
            });
            levelSel.disabled = false;
        }

        function displayUtterances(session, level, searchTerm = '') {
            if (!session || !level) return;

            const rows = data.filter(d => d.session === session && d.level === level)
                             .sort((a, b) => timeToSeconds(a.start_time) - timeToSeconds(b.start_time));

            // Show embedded video for the selected session/level
            showEmbeddedVideo(session, level);

            if (isTimelineView) {
                displayTimelineView(rows, searchTerm);
            } else {
                displayListView(rows, searchTerm);
            }
        }

        function displayListView(rows, searchTerm) {
            const container = document.getElementById('utterances');
            container.innerHTML = '';

            rows.forEach(r => {
                const utteranceText = r.utterance || '';
                const row = document.createElement('div');
                row.className = `utterance speaker-${r.speaker.toLowerCase()}`;
                
                // Add timestamp with YouTube link if available
                const timeDiv = document.createElement('div');
                timeDiv.className = 'timeline-time';
                const timestampLink = createYouTubeTimestampLink(r.start_time, r.session, r.level);
                timeDiv.innerHTML = timestampLink;
                row.appendChild(timeDiv);
                
                // Add utterance text with proper wrapping
                const textDiv = document.createElement('div');
                textDiv.className = 'timeline-text';
                
                // Truncate very long text to prevent overflow
                let displayText = utteranceText;
                if (utteranceText.length > 100) {
                    displayText = utteranceText.substring(0, 97) + '...';
                }
                
                const highlightedText = highlightSearchTerms(displayText, searchTerm);
                textDiv.innerHTML = highlightedText;
                row.appendChild(textDiv);
                
                const tagsContainer = document.createElement('div');
                tagsContainer.className = 'utterance-tags';
                
                const fields = [
                    { value: r.communicative_status, type: 'comm' },
                    { value: r.information_level, type: 'info' },
                    { value: r.uncertainty, type: 'unc' },
                    { value: r.utterance_type, type: 'utt' },
                    { value: r.discursive_act, type: 'dis' }
                ];
                
                fields.forEach(field => {
                    const tagInfo = getTagInfo(field.value);
                    if (tagInfo) {
                        const tag = document.createElement('span');
                        tag.className = 'tag';
                        
                        // Check if this tag matches the search term and highlight if so
                        if (searchTerm && tagMatchesSearch(field.value, searchTerm)) {
                            tag.innerHTML = highlightSearchTerms(tagInfo.abbr, searchTerm);
                        } else {
                            tag.textContent = tagInfo.abbr;
                        }
                        
                        tag.setAttribute('title', tagInfo.full);
                        setupTooltipListeners(tag);
                        
                        const category = field.type;
                        if (categoryColors[category]) {
                            tag.style.backgroundColor = categoryColors[category].bg;
                            tag.style.color = categoryColors[category].text;
                        } else {
                            tag.style.backgroundColor = 'rgba(200, 200, 200, 0.8)';
                            tag.style.color = '#333';
                        }
                        
                        tagsContainer.appendChild(tag);
                    }
                });
                
                row.appendChild(tagsContainer);
                container.appendChild(row);
            });
        }

        function displayTimelineView(rows, searchTerm) {
            const blueColumn = document.getElementById('blueColumn');
            const orangeColumn = document.getElementById('orangeColumn');
            
            blueColumn.innerHTML = '';
            orangeColumn.innerHTML = '';
            
            if (rows.length === 0) return;
            
            const startTime = timeToSeconds(rows[0].start_time);
            const endTime = timeToSeconds(rows[rows.length - 1].end_time || rows[rows.length - 1].start_time);
            const totalDuration = endTime - startTime;
            const pixelsPerSecond = 80;
            const containerHeight = Math.max(600, totalDuration * pixelsPerSecond);
            
            document.getElementById('timelineContainer').style.height = containerHeight + 'px';
            
            rows.forEach((r, index) => {
                const utteranceText = r.utterance || '';
                const startSeconds = timeToSeconds(r.start_time);
                const endSeconds = timeToSeconds(r.end_time || r.start_time);
                const duration = endSeconds - startSeconds;
                
                const top = ((startSeconds - startTime) / totalDuration) * containerHeight;
                const height = Math.max(50, (duration / totalDuration) * containerHeight);
                
                const utterance = document.createElement('div');
                utterance.className = `timeline-utterance ${r.speaker.toLowerCase()}`;
                utterance.style.top = top + 'px';
                utterance.style.height = height + 'px';
                utterance.style.zIndex = index + 1;
                
                utterance.addEventListener('mouseenter', function() {
                    this.style.zIndex = '100';
                });
                
                utterance.addEventListener('mouseleave', function() {
                    this.style.zIndex = (index + 1).toString();
                });
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'timeline-time';
                const timestampLink = createYouTubeTimestampLink(r.start_time, r.session, r.level);
                timeDiv.innerHTML = timestampLink;
                utterance.appendChild(timeDiv);
                
                const textDiv = document.createElement('div');
                textDiv.className = 'timeline-text';
                
                let displayText = utteranceText;
                if (utteranceText.length > 100) {
                    displayText = utteranceText.substring(0, 97) + '...';
                }
                
                const highlightedText = highlightSearchTerms(displayText, searchTerm);
                textDiv.innerHTML = highlightedText;
                utterance.appendChild(textDiv);
                
                const tagsContainer = document.createElement('div');
                tagsContainer.className = 'timeline-tags';
                
                const fields = [
                    { value: r.communicative_status, type: 'comm' },
                    { value: r.information_level, type: 'info' },
                    { value: r.uncertainty, type: 'unc' },
                    { value: r.utterance_type, type: 'utt' },
                    { value: r.discursive_act, type: 'dis' }
                ];
                
        fields.forEach(field => {
            const tagInfo = getTagInfo(field.value);
            if (tagInfo) {
                const tag = document.createElement('span');
                tag.className = 'timeline-tag';
                
                // Check if this tag matches the search term and highlight if so
                if (searchTerm && tagMatchesSearch(field.value, searchTerm)) {
                    tag.innerHTML = highlightSearchTerms(tagInfo.abbr, searchTerm);
                } else {
                    tag.textContent = tagInfo.abbr;
                }
                
                tag.setAttribute('title', tagInfo.full);
                setupTooltipListeners(tag);
                
                const category = field.type;
                if (categoryColors[category]) {
                    tag.style.backgroundColor = categoryColors[category].bg;
                    tag.style.color = categoryColors[category].text;
                } else {
                    tag.style.backgroundColor = 'rgba(200, 200, 200, 0.8)';
                    tag.style.color = '#333';
                }
                
                tagsContainer.appendChild(tag);
            }
        });
                
                utterance.appendChild(tagsContainer);
                
                if (r.speaker.toLowerCase() === 'blue') {
                    blueColumn.appendChild(utterance);
                } else {
                    orangeColumn.appendChild(utterance);
                }
            });
        }

        // Event listeners
        document.getElementById('sessionSelect').addEventListener('change', e => {
            currentSession = e.target.value;
            populateLevels(currentSession);
            displayUtterances(currentSession, currentLevel, document.getElementById('searchInput').value);
        });

        document.getElementById('levelSelect').addEventListener('change', e => {
            currentLevel = e.target.value;
            displayUtterances(currentSession, currentLevel, document.getElementById('searchInput').value);
        });

        document.getElementById('searchInput').addEventListener('input', e => {
            const searchTerm = e.target.value;
            displaySearchResults(searchTerm);
        });

        document.getElementById('viewToggle').addEventListener('change', toggleView);

        // Load and parse CSV
        Papa.parse('combined_data.csv', {
            header: true,
            download: true,
            skipEmptyLines: true,
            complete: results => {
                data = results.data;
                populateSessions();
            },
            error: err => console.error('CSV load error:', err)
        });
    </script>
</body>
</html>
